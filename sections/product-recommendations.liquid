<div class="bg-gray-300 py-8">
  <div class="max-w-7xl mx-auto px-4">
    <h2 class="font-bold text-blue-500 text-xl md:border-l-8 md:border-blue-500 md:pl-2">
      RECOMMENDED PRODUCTS
    </h2>

    <div
      class="mt-8 product-recommendations"
      data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit=3"
    >
      {% if recommendations.performed and recommendations.products_count > 0 %}
        <div class="grid recommendations-grid text-blue-500">
          <div>
            <div class="swiper" id="recommended-swiper">
              <div class="swiper-wrapper">
                {% for product in recommendations.products %}
                {% assign sca_product = product %}{% assign sca_product_id_text = "," | append : sca_product.id | append : "," %}{% assign sca_price = sca_product.price %}{% assign sca_price_min = sca_product.price_min %}{% assign sca_price_max = sca_product.price_max %}{% assign sca_compare_at_price = sca_product.compare_at_price %}{% assign sca_compare_at_price_min = sca_product.compare_at_price_min %}{% assign sca_compare_at_price_max = sca_product.compare_at_price_max %}{% assign sca_product_available = sca_product.available %}{% assign sca_product_variantCount = sca_product.variants.size %}{% assign sca_compare_at_price_varies = sca_product.compare_at_price_varies %}{% assign sca_price_varies = sca_product.price_varies %}{% assign sca_has_only_default_variant = false %}{% capture sca_product_variants_json %}{{sca_product.variants | json }}{% endcapture %} {% capture sca_product_json %}{ {% if sca_all_gift_products_ids == null or sca_all_gift_products_ids contains sca_product_id_text %}{% assign sca_product_available = false %}{% assign sca_product_variantCount = 0 %}{% assign sca_has_only_default_variant = true %}{% assign sca_is_first_variant = true %}{% capture sca_variants_json %} [{% for variant in sca_product.variants %}{% unless variant.metafields.secomapp.freegifts %}{% unless variant.title contains '(Freegifts)' %}{% unless variant.title contains '% Off' %}{% unless variant.metafields.shappify_qb.qb_hide == "1" %}{% unless variant.metafields.shappify_bundle.is_bundle == "true" %}{% unless variant.metafields.brodev_scn.hide == "true" %}{% unless variant.metafields.wholesaler2.wholesale %}{% unless variant.metafields.Wholesaler.level %}{% unless variant.title contains '(Wholesale' %}{% if sca_is_first_variant%} {{ variant | json }}{% assign sca_price = variant.price %} {% assign sca_price_min = variant.price %} {% assign sca_price_max = variant.price %} {% assign sca_compare_at_price = variant.compare_at_price %} {% assign sca_compare_at_price_min = variant.compare_at_price %} {% assign sca_compare_at_price_max = variant.compare_at_price %} {% assign sca_product_available = variant.available %} {% assign sca_product_variantCount = 1 %} {% assign sca_is_first_variant = false%}{% else %},{{variant | json }} {% if sca_price_min >= variant.price %} {% assign sca_price_min = variant.price %} {% assign sca_price = variant.price %}{% endif %} {% if sca_price_max <= variant.price %} {% assign sca_price_max = variant.price %} {% endif %} {% if variant.compare_at_price %} {% if sca_compare_at_price_min==null or sca_compare_at_price_min >= variant.compare_at_price %} {% assign sca_compare_at_price_min = variant.compare_at_price %} {% assign sca_compare_at_price = variant.compare_at_price %} {% endif %} {% if sca_compare_at_price_max==null or sca_compare_at_price_max < variant.compare_at_price %} {% assign sca_compare_at_price_max = variant.compare_at_price %} {% endif %} {% endif %} {% if variant.available == true %} {% assign sca_product_available = true %} {% endif %} {% assign sca_product_variantCount = sca_product_variantCount | plus: 1 %}{% endif %}{% endunless %}{% endunless %}{% endunless %}{% endunless %}{% endunless %}{% endunless %}{% endunless %}{% endunless %}{% endunless %}{%endfor%} ]{% endcapture %}{% if sca_price_min < sca_price_max %}{% assign sca_price_varies = true %}{% else %}{% assign sca_price_varies = false %}{% endif %}{% if sca_compare_at_price_min < sca_compare_at_price_max %}{% assign sca_compare_at_price_varies = true %}{% else %}{% assign sca_compare_at_price_varies = false %}{% endif %}{% if sca_product_variantCount > 1 %}{% assign sca_has_only_default_variant = false %}{% endif %}{% if sca_product_variantCount == sca_product.variants.size %} "variants":{{ sca_product.variants }},{% else %}{%assign sca_product_variants_json = sca_variants_json %} "variants":{{ sca_variants_json }},{% endif %}{% else %} "variants":{{ sca_product_variants_json }},{% endif %} "id": {{sca_product.id}}, "title": {{sca_product.title | json}}, "handle": {{sca_product.handle | json}}, "description": {{sca_product.description | json}}, "published_at": "{{sca_product.published_at | date: "%Y-%m-%dT%H-%M-%S%:z" }}", "created_at": "{{sca_product.created_at | date: "%Y-%m-%dT%H-%M-%S%:z" }}", "vendor": {{sca_product.vendor | json}}, "type": {{sca_product.type | json}}, "tags": {{sca_product.tags | json}}, "price": {{sca_price}}, "price_min": {{sca_price_min}}, "price_max": {{sca_price_max}}, "available": {{sca_product.available}}, "price_varies": {{sca_price_varies}}, "compare_at_price": {{sca_compare_at_price}}, "compare_at_price_min": {{sca_compare_at_price_min}}, "compare_at_price_max": {{sca_compare_at_price_max}}, "compare_at_price_varies": {{sca_compare_at_price_varies}}, "images": {{sca_product.images | json}}, "featured_image": {{sca_product.featured_image | json }}, "options": {{sca_product.options | json}}, "media": {{sca_product.media | json }}, "content": {{sca_product.content | json }}} {% endcapture sca_product_json %}
                  {%- if product.tags contains 'hidden-by-tag' -%}
                    {%- continue -%}
                  {%- endif -%}

                  {% assign split_title = product.title | split: '|' %}

                  <div class="swiper-slide">
                    <div class="flex flex-col h-full justify-between p-4 relative z-10">
                      <div class="absolute bg-white bottom-0 left-0 right-0 rounded-xl top-1/4 z-[-1]"></div>

                      <div>
                        <a class="block max-w-[230px] mx-auto" href="{{ product.url }}">
                          {% render 'lazy-image',
                            height: 230,
                            image: product.featured_image,
                            width: 230,
                          %}
                        </a>

                        <div class="flex mb-4">
                          <div class="flex-1 mr-4">
                            <p class="text-sm">
                              {{ split_title[1] }}
                            </p>

                            <p class="font-semibold text-xl">
                              {{ split_title[0] }}
                            </p>
                          </div>

                          <div>
                            <p class="font-semibold text-xl">{{ sca_price | money }}</p>
                          </div>
                        </div>
                      </div>

                      <div>
                        <a
                          class="block button-alt text-center w-full"
                          href="{{ product.url }}"
                        >
                          View Product
                        </a>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="mt-4 recommended-swiper__pagination text-center"></div>
            </div>
          </div>

          <div class="hidden relative w-full xl:block">
            <a
              class="absolute bg-white bottom-0 flex flex-col font-semibold justify-center left-0 ml-8 px-3 right-0 rounded-md text-center text-sm top-1/4 transition-opacity hover:opacity-70"
              href="/collections/all"
            >
              SHOP ALL<br/>PRODUCTS
              {% render 'icon-arrow-right', with class: 'mx-auto mt-3' %}
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .recommendations-grid {
    grid-template-columns: 88% 12%;
  }

  .recommendations-grid .swiper-slide {
    height: auto !important;
  }

  @media screen and (max-width: 1024px) {
    .recommendations-grid {
      grid-template-columns: 100%;
    }
  }
</style>

<script>
  const handleIntersection = (entries, observer) => {
    if (!entries[0].isIntersecting) return;

    observer.unobserve(productRecommendationsSection);

    const url = productRecommendationsSection.dataset.url;

    fetch(url)
      .then((response) => response.text())
      .then((text) => {
        const html = document.createElement('div');
        html.innerHTML = text;
        const recommendations = html.querySelector('.product-recommendations');

        if (recommendations && recommendations.innerHTML.trim().length) {
          productRecommendationsSection.innerHTML = recommendations.innerHTML;

          // Loop & wait for Swiper global variable to become available
          const interval = setInterval(() => {
            if (window.Swiper) {
              clearInterval(interval);

              new Swiper('#recommended-swiper', {
                autoplay: {
                  delay: 5000,
                },
                breakpoints: {
                  640: {
                    slidesPerView: 2,
                  },
                  1024: {
                    slidesPerView: 3,
                    spaceBetween: 32,
                  }
                },
                pagination: {
                  bulletActiveClass: 'pagination-bars-active',
                  bulletClass: 'pagination-bars',
                  clickable: true,
                  el: '.recommended-swiper__pagination',
                  renderBullet: function (index, className) {
                    return `<button class="${className} bg-gray-400 h-1 mx-1 rounded-md w-4" type="button"></button>`
                  },
                },
                spaceBetween: 16,
              });
            }
          }, 200);
        }
      })
      .catch((e) => {
        console.error(e);
      });
  };

  const productRecommendationsSection = document.querySelector('.product-recommendations');
  const observer = new IntersectionObserver(handleIntersection, { rootMargin: '0px 0px 200px 0px' });

  observer.observe(productRecommendationsSection);
</script>

{% schema %}
  {
    "name": "Product Recommendations",
    "settings": []
  }
{% endschema %}
