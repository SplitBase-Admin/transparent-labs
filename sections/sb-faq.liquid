{% liquid
  assign uses_metafields = false
  assign blocks = section.blocks | map: 'settings'
  if product and section.settings.use_template_faq == true and product.metafields.custom.new_produc_faqs.value.count > 0
    assign uses_metafields = true
    assign blocks = product.metafields.custom.new_produc_faqs.value
    assign should_render = true
  elsif collection and section.settings.use_collection_faq == true and collection.metafields.custom.faq.value.count > 0
    assign uses_metafields = true
    assign blocks = collection.metafields.custom.faq.value
    assign should_render = true
  elsif section.settings.use_template_faq == false and blocks.size > 0
    assign should_render = true
  endif
%}

{% if should_render %}
  <div class="sb-faq sb-styled-element" style="{%  render 'style-attributes', settings: section.settings, mobile_multiple: 0.55 %}">
    <div class="sb-faq__container sb-page-width">
      {% if section.settings.heading != blank %}
        <h2 class="sb-faq__heading">{{ section.settings.heading }}</h2>
      {% endif %}
      
      <!-- Mobile Accordion -->
      <sb-accordion class="sb-faq__accordion sb-faq__accordion--mobile">
        {% for block in blocks %}
          {% if block.question != empty and block.answer != empty %}
            <div class="sb-accordion__item sb-faq__item" {% if forloop.first %}data-default-open{% endif %} {{ block.shopify_attributes }}>
              <button class="sb-accordion__trigger sb-faq__question-trigger" aria-expanded="false">
                <span class="sb-faq__question-text">{{ block.question }}</span>
                <span class="sb-accordion__icon sb-faq__icon"></span>
              </button>
              <div class="sb-accordion__content sb-faq__answer">
                <div class="sb-faq__answer-content">
                  {% if uses_metafields  %}
                    {{ block.answer | metafield_tag }}
                  {% else %}
                    {{ block.answer }}
                  {% endif %}
                </div>
              </div>
            </div>
            {% unless forloop.last %}
              <div class="sb-faq__divider">&nbsp;</div>
            {% endunless %}
          {% endif %}
        {% endfor %}

      </sb-accordion>
        
      <!-- Desktop Grid -->
      <div class="sb-faq__grid sb-faq__grid--desktop">
        {% for block in blocks %}
          {% if block.question != empty and block.answer != empty %}
            <div class="sb-faq__item sb-faq__item--static" {{ block.shopify_attributes }}>
              <h3 class="sb-faq__question">{{ block.question }}</h3>
              <div class="sb-faq__answer sb-faq__answer--static">
                {% if uses_metafields  %}
                  {{ block.answer | metafield_tag }}
                {% else %}
                  {{ block.answer }}
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
            
      {% if section.settings.link != blank and section.settings.cta != blank %}
        {% render 'sb-button', button_text: section.settings.cta, button_url: section.settings.link, button_type: 'link' %}
      {% endif %}
    
      <script src="{{ 'sb-accordion.js' | asset_url }}" defer="defer"></script>
    </div>
  </div>
{% endif %}

{% stylesheet %}
  
  /* Heading */
  .sb-faq__heading {
    font-weight: 600;
    font-size: 28px;
    line-height: 1.2;
    color: var(--sb-fg-color, #000);
    margin: 0;
  }
  
  /* Mobile Accordion */
  .sb-faq__accordion--mobile {
    display: block;
    margin-top: 32px;
  }
  
  
  .sb-faq .sb-accordion__trigger {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
    background: none;
    border: none;
    text-align: left;
    cursor: pointer;
    color: inherit;
    gap: 32px;
    padding:0;
  }
  
  .sb-faq .sb-faq__question-text {
    font-size: 18px;
    line-height: 1.3;
    flex: 1;
    font-family: var(--sb-font-family-heading, 'Aeonik');
  }
  
  .sb-faq .sb-accordion__icon {
    width: 16px;
    height: 16px;
    position: relative;
    transition: transform 0.3s ease;
    flex-shrink: 0;
    margin-top: 2px;
  }
  
  .sb-faq .sb-accordion__icon::before,
  .sb-faq .sb-accordion__icon::after {
    content: "";
    position: absolute;
    background-color: var(--sb-fg-color, #000);
    transition: transform 0.3s ease;
  }
  
  .sb-faq .sb-accordion__icon::before {
    width: 100%;
    height: 2px;
    top: 7px;
    left: 0;
  }
  
  .sb-faq .sb-accordion__icon::after {
    width: 2px;
    height: 100%;
    left: 7px;
    top: 0;
  }
  
  .sb-faq .sb-accordion__item--expanded .sb-accordion__icon::after {
    transform: rotate(90deg);
  }
  
  .sb-faq .sb-accordion__content {
    max-height: 0;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.215, 0.61, 0.355, 1);
    padding: 0;
    opacity: 0;
    transform: translateY(-10px);
  }
  
  .sb-faq .sb-accordion__item--expanded .sb-accordion__content {
    max-height: 1000px;
    padding: 0 0 var(--sb-faq-spacing-sm);
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }
  
  .sb-faq .sb-faq__answer-content {
    line-height: 1.4;
  }
  
  .sb-faq .sb-faq__answer-content .metafield-rich_text_field {
    padding: 8px 0  0;
    opacity: 0.6;
  }
  
  .sb-faq .sb-faq__answer-content p:last-child {
    margin-bottom: 0;
  }

  .sb-faq .sb-faq__answer-content .metafield-rich_text_field > * {
    margin-top: 0;
  }
  
  .sb-faq .sb-faq__answer-content strong {
    font-weight: 700;
    color: var(--sb-faq-color-text-secondary);
  }
  
  .sb-faq__divider {
    width: 100%;
    height: 1px;
    background-color: var(--sb-fg-color, #000);
    margin: 32px 0;
    opacity: 0.3;
  }
  
  .sb-faq .sb-button {
    margin-top: 48px;
  }
  
  /* Desktop Grid - Hidden on mobile */
  .sb-faq__grid--desktop {
    display: none;
  }
  
  /* Desktop Styles */
  @media (min-width: 768px) {
    
    .sb-faq__heading {
      font-size: 40px;
      max-width: 360px;
    }
    
    /* Hide mobile accordion on desktop */
    .sb-faq__accordion--mobile {
      display: none;
      margin-top: 0
    }
    
    /* Show desktop grid */
    .sb-faq__grid--desktop {
      margin-top: 48px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 32px;
      align-items: start;
    }
    
    .sb-faq__question {
      font-weight: 600;
      font-size: 20px;
      line-height: 1.3;
      margin-bottom: 16px;
      margin-top: 0;
    }
    
    .sb-faq__answer--static {
      font-size: 16px;
      line-height: 1.4;
      opacity: 0.6;
    }
    
    .sb-faq__answer--static p {
      margin-bottom: 14px;
    }
    
    .sb-faq__answer--static p:last-child {
      margin-bottom: 0;
    }

    .sb-faq__answer--static a{
      color: inherit;
    }

    .sb-faq .sb-button{
      display: none;
    }
  }
  
  /* Large desktop adjustments */
  @media (min-width: 1024px) {
    .sb-faq__grid--desktop {
      grid-template-columns: repeat(3, 1fr);
      gap: 56px 80px;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "SB FAQ",
  "settings": [
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Frequently Asked Questions"
    },
    {
      "type": "checkbox",
      "id": "use_template_faq",
      "label": "Use Template FAQ",
      "default": false,
      "info": "Enable this to use the FAQ from the Product or Collection Metafields. Will override blocks. Only on Product and Collection pages."
    },
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "url",
      "id": "link",
      "label": "Button link"
    },
    {
      "type": "text",
      "id": "cta",
      "label": "Button CTA"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "fg_color",
      "label": "Color"
    },
    {
      "type": "color_background",
      "id": "bg_color",
      "label": "Background Color"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding Top",
      "default": 0,
      "min": 0,
      "max": 100
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding Bottom",
      "default": 0,
      "min": 0,
      "max": 100
    }
  ],
  "blocks": [
    {
      "type": "question",
      "name": "Question",
      "settings": [
        {
          "type": "text",
          "id": "question",
          "label": "Question"
        },
        {
          "type": "richtext",
          "id": "answer",
          "label": "Answer"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "SB FAQ"
    }
  ]
}
{% endschema %}
