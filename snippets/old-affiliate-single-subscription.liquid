<product-grid-item class="{% for tag in product.tags %}{% if tag contains 'TLsvegan' %} vegan_class {% elsif tag contains "StimulantFree" %} StimulantFree {% endif %} {% endfor %}bg-white flex flex-col p-4 rounded-xl text-blue-500 xgen-new-product stack-products_{{block_id}}_{{product.id}}">
  <div class="xgan-ptag">{{product_type}}</div>
  <div class="xgen-product-img">
  
    {% assign split_title = product.title | split: '|' %}
    {% if product.variants.size == 1 or product.tags contains 'use-featured-image' %}
      <a class="block mx-auto w-64" href="{{ product.url | within: collection }}">
          <img src="{{product.featured_image | img_url: 'master'}}" alt="{{ product.featured_image.alt }}" loading="lazy" />
      </a>
    {% else %}
      <div class="swiper render-swiper">
        <div class="swiper-wrapper">
          {% for variant in product.variants %}
            {% if variant.option2 == '2 Tub' or variant.option2 == '3 Tub' %}
              {% continue %}
            {% endif %}
            <div class="swiper-slide" data-variant-id="{{ variant.id }}">
              <a class="block mx-auto w-64" href="{{ product.url | within: collection }}">
                <img src="{{product.featured_image | img_url: 'master'}}" alt="{{ product.featured_image.alt }}" loading="lazy" />
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
  <div class="xgen-product-info">
    <div class="xgen-product-info-in">
      <div class="flex rctitle-flex">

      <!--<h3 class="font-normal">
        {{ split_title[1] }}
      </h3>-->
        <h2 class="font-semibold text-xl xgen-ptitle">
        {{ split_title[0] }}
      </h2>
        <div class="font-semibold  text-blue-400 text-xl variant-price">
                <div class="real_price_{{block_id}}_{{product.id}}"></div>
                <del class="com_price_{{block_id}}_{{product.id}}"></del>
          </div> 
      </div>
      {% comment %}
       <div class="flex items-center text-sm">
              <div class="flex space-x-1 text-orange-400">
                {%- assign review_average = product.metafields.yotpo.reviews_average | times: 1 -%}
                {%- for i in (1..5) -%}
                  {%- assign index_minus_one = i | minus: 1 -%}
                  {%- assign mod = review_average | modulo: index_minus_one -%}

                  {%- if review_average >= i -%}
                    <svg class="h-4 w-4" version="1.1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
                      <path d="m47.961 48h-47.945l39.914 31.543-15.941 48.441 40.059-29.871 39.938 29.871-15.871-48.863 39.918-31.121h-47.945l-16.094-47.996z" fill="currentColor"></path>
                    </svg>
                  {%- elsif mod >= 0.5 -%}
                    <svg class="h-4 w-4" version="1.1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
                      <path d="m128.02 48h-47.953l-16.094-48-16.031 48h-47.969l39.937 31.555-15.953 48.445 39.984-29.812 0.09375-0.0625 39.938 29.875-15.875-48.867zm-39.594 58.531-24.371-18.547-0.058594 0.0625v-56.953l10.164 24.906h29.812l-25.453 19.43z" fill="currentColor"></path>
                    </svg>
                  {%- else -%}
                    <svg class="h-4 w-4" version="1.1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
                      <path d="m64.008 31.113 10.172 24.887h29.809l-25.449 19.426 9.9023 31.105-24.387-18.543-24.387 18.109 9.8711-30.156-25.539-19.941h29.871l10.137-24.887m-16.043 16.887h-47.949l39.914 31.551-15.93 48.445 40.055-29.867 39.934 29.871-15.875-48.871 39.918-31.129h-47.945l-16.094-47.996z" fill="currentColor"></path>
                    </svg>
                  {%- endif %}
                {%- endfor -%}
              </div>

              <p class="ml-3 text-gray-500">
                <span class="font-bold text-black">{{ product.metafields.yotpo.reviews_average }}</span>/5.0
              </p>
            </div>
        {% endcomment %}
                    
      <div class="xtags">
         <span>Bestseller</span>
         <span>10% Off</span>
         <span>Free Shipping</span>
         
                    {% if txt1 != blank %}
                      <span>{{txt1}}</span>
                    {% endif %}
                    {% if txt2 != blank %}
                      <span>{{txt2}}</span>
                    {% endif %}
                    {% if txt3 != blank %}
                      <span>{{txt3}}</span>
                    {% endif %}
                    {% if txt4 != blank %}
                      <span>{{txt4}}</span>
                    {% endif %}
                  </div>

                    {% if txt5 != blank %}
                     <ul class="xstacklist">
                      {{txt5}}
                      </ul>
                    {% endif %}
      
      {% comment %}{% endcomment %}
    </div>
 <div class="xgen-pdesc">
        {{ detail }}
      </div> 
    
            <div class="package-list-wraper stack-text">
                  {% if product.variants.size > 0 %}
                  	{% if product.options[0] %}
                       <div class="package-list   ">
                  		<div class="input-wraper">
                          {% assign used = '' %}
                          <label for="select-one_{{product.id}}{{product.id}}">{{ product.options[0] }}</label>
                          <select id='select-one_{{product.id}}{{product.id}}' onchange="letsDoThis_{{product.id}}_{{product.id}}()">
                          {% for variant in product.variants %}
                            	{% unless variant.inventory_quantity == 0 %}
                          		{% unless used contains variant.option1 %}
                            		<option value="{{ variant.option1 }}">{{ variant.option1 }}</option>
                            		{% capture used %}{{ used }} {{ variant.option1 }}{% endcapture %}
                            	{% endunless %}
                            	{% endunless %}
                            
                          {% endfor %}
                          </select>
                         </div>
                       </div>
                    {% endif %}
                  	{% if product.options[1] %}
                       <div class="package-list   ">
                     <div class="input-wraper">        
                      {% assign used = '' %}
                      <label for="select-one_{{product.id}}{{product.id}}">{{ product.options[1] }}</label>
                      <select id='select-two_{{product.id}}{{product.id}}' onchange="letsDoThis_{{product.id}}_{{product.id}}()">
                          {% for variant in product.variants %}
                        	{% unless variant.inventory_quantity == 0 %}
                              {% unless used contains variant.option2 %}
                                  <option value="{{ variant.option2 }}">{{ variant.option2 }}</option>
                                  {% capture used %}{{ used }} {{ variant.option2 }}{% endcapture %}
                              
                        	{% endunless %}
                        	{% endunless %}
                          {% endfor %}
                      </select>
                  	</div>
                       </div>
                  {% endif %}
                  {% if product.options[2] %}
                     <div class="package-list   ">
                  <div class="input-wraper">        
                      {% assign used = '' %}
                      <label for="select-one_{{product.id}}{{product.id}}">{{ product.options[2] }}</label>
                      <select id='select-three_{{product.id}}{{product.id}}' onchange="letsDoThis_{{product.id}}_{{product.id}}()">
                          {% for variant in product.variants %}
                        {% unless variant.inventory_quantity == 0 %}
                              {% unless used contains variant.option3 %}
                                  <option value="{{ variant.option3 }}">{{ variant.option3 }}</option>
                                  {% capture used %}{{ used }} {{ variant.option3 }}{% endcapture %}
                              {% endunless %}
                        {% endunless %}
                          {% endfor %}
                      </select>
                  </div>
                     </div>
                  {% endif %}
              {% endif %}
			<input type="hidden" name="id" id="product-select_{{product.id}}_{{product.id}}" class="stack_vid3" value="{{ product.selected_or_first_available_variant.id }}" />	
       		<div class="p1_selling_plan_{{product.id}}_{{block_id}}_{{product.id}}" style="display:none;"></div>                
          <div class="package-list np_last">
              <p>Delivery Frequency</p>
              <select class="selling_plan_{{block_id}}_{{ product.id }}">
            
              </select>
            </div>
      
        <script type="text/javascript">
        function letsDoThis_{{product.id}}_{{product.id}}() 
        {
        ////console.log("clicked!");
        {% if product.options[0] %}
                        var opt1 = document.getElementById("select-one_{{product.id}}{{product.id}}").value;
                    {% endif %}
					
                                                           
                    {% if product.options[1] %}
                        var opt2 = document.getElementById("select-two_{{product.id}}{{product.id}}").value;
                    {% endif %}
					
                                                           
                    {% if product.options[2] %}
                        var opt3 = document.getElementById("select-three_{{product.id}}{{product.id}}").value;
                    {% endif %}
                                                           
                    var id = "";
					
                    {% for v in product.variants %}
						 {% unless v.inventory_quantity == 0 %}
                  
                        	if(opt1=="{{ v.option1 }}" {% if product.options[1] %} && opt2 =="{{ v.option2 }}" {% endif %} {% if product.options[2] %} && opt3 == "{{ v.option3 }}" {% endif %}) 
                        	{
                            	var id = {{ v.id }};
                            	var price = "{{ v.price | money }}";
                        	}
                   		{% endunless %}
                    {% endfor %}
                    if(id!='') 
                    {
                        document.getElementById("product-select_{{product.id}}_{{product.id}}").value = id;
                    } 
                    else 
                    {
                        document.getElementById("product-select_{{product.id}}_{{product.id}}").value = '';
					}
                }

                var variant_values = {{ product.variants | json }};
                //console.log(variant_values);
                var len = variant_values.length;
                var rechargeSellingPlanGroup = {{ product.selling_plan_groups | where: "app_id", "SKIO" | json }}

                for(var i = 0; i < len; i++)
                {
                    ////console.log(variant_values[i].id);
                    var rechargeAllocations = variant_values[i].selling_plan_allocations.filter(allocation => allocation.selling_plan_group_id == rechargeSellingPlanGroup[0].id)

                    var len2 = rechargeAllocations.length;
                    var plans = rechargeAllocations;
                    for(var j=0; j < len2; j++)
                    {
                        const sellingPlanSelect = document.querySelector(".selling_plan_{{block_id}}_{{ product.id }}");
                        const sellingPlanInputContainer = document.querySelector(".p1_selling_plan_{{product.id}}_{{block_id}}_{{product.id}}");
                        
                        if(j == 0 && sellingPlanSelect)
                        {
                          const option = document.createElement('option');
                          option.value = 'selling_plan_' + j;
                          option.textContent = 'Delivery every 15 days';
                          sellingPlanSelect.appendChild(option);
                        }
                        if(j == 1 && sellingPlanSelect)
                        {
                          const option = document.createElement('option');
                          option.value = 'selling_plan_' + j;
                          option.textContent = 'Delivery every 30 days';
                          option.selected = true;
                          sellingPlanSelect.appendChild(option);
                        }
                        if(j == 2 && sellingPlanSelect)
                        {
                          const option = document.createElement('option');
                          option.value = 'selling_plan_' + j;
                          option.textContent = 'Delivery every 45 days';
                          sellingPlanSelect.appendChild(option);
                        }
                       
                        if(sellingPlanInputContainer) {
                          const input = document.createElement('input');
                          input.className = 'onetime selling_plan_' + j;
                          input.setAttribute('data-stack', '{{block.id}}_{{product.id}}');
                          input.setAttribute('data-price', plans[j].price);
                          input.setAttribute('data-otp', plans[j].compare_at_price);
                          input.name = 'selling_plan';
                          input.value = plans[j].selling_plan_id;
                          sellingPlanInputContainer.appendChild(input);
                        }
//                             //console.log(plans[j].selling_plan_id);
                    }
                    if(i == 0)
                    {
                        break;
                    }
                          
                }
                </script>

   
     
        	
      </div>





              <div class="gap-8 grid grid-cols-2 items-center mt-4 price-btn-grid">
                <!--<h6 class="update_main_price_{{block_id}}_{{product.id}}">
        		{{ product.price | money }}
              </h6> -->
               <div class=" pricetext">
                 <div class="flex items-center quant-btn">
                <div class="mr-4 md:mr-8">
                  <legacy-quantity-input>
                    <div class="flex items-center text-blue-500">
                      <button
                        class="bg-gray-300 flex h-10 items-center justify-center rounded-full text-blue-light w-10"
                        type="button"
                      >
                        {% render 'old-icon-minus' %}
                      </button>

                      <input
                        class="border-2 border-gray-300 bg-transparent hide-selectors outline-none mx-2 rounded text-center w-16 focus:ring-0"
                        min="1"
                        name="quantity"
                        type="number"
                        value="1"
                        id="stack-products_qty_{{block_id}}_{{product.id}}"
                      />

                      <button
                        class="bg-gray-300 flex h-10 items-center justify-center rounded-full text-blue-light w-10"
                        type="button"
                      >
                        {% render 'old-icon-plus' %}
                      </button>
                    </div>
                  </legacy-quantity-input>
                </div>
                <div class="w-full" id="add-to-cart-button-container">
                  <button class="submit-stack-products_{{block_id}}_{{product.id}} button-alt" >Subscribe</button>
                </div>
             </div>
          </div>
      	</div>

  
    </div>
	
</product-grid-item>
<script type="text/javascript">
/**
 * Subscription product functionality
 * Handles subscription and one-time purchase functionality with vanilla JavaScript
 */
document.addEventListener('DOMContentLoaded', function() {
  
  /**
   * Format price from cents to dollars
   * @param {number} num - Price in cents
   * @returns {string} Formatted price
   */
  function format(num) { 
    return (num / 100).toFixed(2);
  }

  /**
   * Update cart count display
   * @param {number} count - Cart item count
   */
  function updateCartCount(count) {
    const cartCountElement = document.getElementById('cart-count');
    if (cartCountElement) {
      if (count < 1) {
        cartCountElement.innerHTML = "";
      } else {
        cartCountElement.innerHTML = `<number class='number'>${count}</number>`;
      }
    }
  }

  /**
   * Update price display based on selling plan
   * @param {string} selling_plan_val - Selected selling plan value
   */
  function updatePriceDisplay(selling_plan_val) {
    const stackContainer = document.querySelector(".stack-products_{{block_id}}_{{product.id}}");
    const realPriceElement = document.querySelector(".real_price_{{block_id}}_{{product.id}}");
    const comparePriceElement = document.querySelector(".com_price_{{block_id}}_{{product.id}}");
    
    if (!stackContainer || !realPriceElement || !comparePriceElement) return;

    const stackTextElements = stackContainer.querySelectorAll(".stack-text");
    
    if (selling_plan_val === "selling_plan_0" || selling_plan_val === "selling_plan_1" || selling_plan_val === "selling_plan_2") {
      stackTextElements.forEach((data, i) => {
        if (i < 1) {
          const priceElement = data.querySelector(`.${selling_plan_val}`);
          if (priceElement) {
            const total = parseInt(priceElement.getAttribute('data-price'));
            const parsed_total = format(total);
            realPriceElement.textContent = "$" + parsed_total;
            
            const otptotal = parseInt(priceElement.getAttribute('data-otp'));
            const parsed_otptotal = format(otptotal);
            comparePriceElement.textContent = "$" + parsed_otptotal;
          }
        }
      });
    } else {
      stackTextElements.forEach((data) => {
        const priceElement = data.querySelector(`.${selling_plan_val}`);
        if (priceElement) {
          const total = parseInt(priceElement.getAttribute('data-price'));
          const parsed_total = format(total);
          realPriceElement.textContent = "$" + parsed_total;
          comparePriceElement.textContent = "";
        }
      });
    }
  }

  // Get purchase option values
  const purchaseOptionInput = document.querySelector("input[name='purchaseoption_{{block_id}}_{{product.id}}']:checked");
  const freq_val = purchaseOptionInput ? purchaseOptionInput.dataset.text : null;
  
  // Get selling plan selector
  const sellingPlanSelect = document.querySelector(".selling_plan_{{block_id}}_{{ product.id }}");
  const freqTextElement = document.querySelector(".freq_text_{{block_id}}_{{product.id}}");
  
  // Initial price update
  if (sellingPlanSelect) {
    const selling_plan_val = sellingPlanSelect.value;
    updatePriceDisplay(selling_plan_val);
  }
  
  // Set frequency text
  if (freqTextElement && freq_val) {
    freqTextElement.textContent = freq_val;
  }

  // Add change event listener to selling plan selector
  if (sellingPlanSelect) {
    sellingPlanSelect.addEventListener('change', function() {
      const selling_plan_val = this.value;
      const submitButton = document.querySelector(".submit-stack-products_{{block_id}}_{{product.id}}");
      
      if (selling_plan_val === "selling_plan_0" || selling_plan_val === "selling_plan_1" || selling_plan_val === "selling_plan_2") {
        if (submitButton) submitButton.textContent = "Subscribe";
        updatePriceDisplay(selling_plan_val);
      } else {
        if (submitButton) submitButton.textContent = "Add To Cart";
        updatePriceDisplay(selling_plan_val);
      }
    });
  }

  // Add click event listener to submit button
  const submitButton = document.querySelector(".submit-stack-products_{{block_id}}_{{product.id}}");
  if (submitButton) {
    submitButton.addEventListener("click", function() {
      const sellingPlanSelect = document.querySelector(".selling_plan_{{block_id}}_{{ product.id }}");
      const selling_plan_val = sellingPlanSelect ? sellingPlanSelect.value : '';
      const stackContainer = document.querySelector(".stack-products_{{block_id}}_{{product.id}}");
      const quantityInput = document.querySelector("#stack-products_qty_{{block_id}}_{{product.id}}");
      
      let items = [];
      
      if (selling_plan_val === "selling_plan_0" || selling_plan_val === "selling_plan_1" || selling_plan_val === "selling_plan_2") {
        // Subscription purchase
        if (stackContainer) {
          const stackTextElements = stackContainer.querySelectorAll(".stack-text");
          stackTextElements.forEach((data) => {
            const variantInput = data.querySelector('.stack_vid3');
            const sellingPlanInput = data.querySelector(`.${selling_plan_val}`);
            
            if (variantInput && sellingPlanInput) {
              items.push({
                id: parseInt(variantInput.value),
                quantity: quantityInput ? quantityInput.value : 1,
                selling_plan: parseInt(sellingPlanInput.value)
              });
            }
          });
        }
      } else if (selling_plan_val === "onetime") {
        // One-time purchase
        if (stackContainer) {
          const stackTextElements = stackContainer.querySelectorAll(".stack-text");
          stackTextElements.forEach((data) => {
            const variantInput = data.querySelector('.stack_vid3');
            if (variantInput) {
              items.push({
                id: parseInt(variantInput.value),
                quantity: quantityInput ? quantityInput.value : 1
              });
            }
          });
        }
      }

      // Process cart additions
      if (items.length > 0) {
        processCartAdditions(items, submitButton);
      }
    });
  }

  /**
   * Process multiple cart additions in a single request
   * @param {Array} items - Array of items to Add To Cart
   * @param {HTMLElement} submitButton - Submit button element
   */
  async function processCartAdditions(items, submitButton) {
    submitButton.textContent = "Adding...";
    
    try {
      // Add all items to cart in a single request
      const cart = (document.querySelector('cart-notification') || document.querySelector('cart-drawer'))
      const data = await addItemsToCart(items, cart);
      
      // Update button text based on purchase type
      const sellingPlanSelect = document.querySelector(".selling_plan_{{block_id}}_{{ product.id }}");
      const selling_plan_val = sellingPlanSelect ? sellingPlanSelect.value : '';
      
      if (selling_plan_val === "selling_plan_0" || selling_plan_val === "selling_plan_1" || selling_plan_val === "selling_plan_2") {
        submitButton.textContent = "Subscribe";
      } else {
        submitButton.textContent = "Add To Cart";
      }
      
      // Update cart and publish events
      
      
      
      
      // Open cart drawer following the pattern from product grid
      if (cart && data.sections) {
        cart.renderContents(data);
        publish(PUB_SUB_EVENTS.cartUpdate, {source: 'affiliate-single-subscription'});
        cart.openCartDrawer();
      }
      
    } catch (error) {
      console.error('Error adding items to cart:', error);
      submitButton.textContent = "Subscribe";
    }
  }

  /**
   * Add multiple items to cart in a single request using Fetch API
   * @param {Array} items - Array of items to Add To Cart
   * @returns {Promise} Fetch promise
   */
  function addItemsToCart(items, cart) {
    const requestBody = {
      items: items.map(item => {
        const cartItem = {
          id: item.id,
          quantity: item.quantity
        };
        
        if (item.selling_plan) {
          cartItem.selling_plan = item.selling_plan;
        }
        
        return cartItem;
      })
    };
    if (cart) {
      requestBody.sections = cart.getSectionsToRender().map((section) => section.id)
    }
    
    return fetch('/cart/add.js', {
      method: 'POST',
      body: JSON.stringify(requestBody),
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    });
  }

});
</script>
