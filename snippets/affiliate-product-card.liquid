{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign short_title = product.metafields.product_details.title
  assign subtitle = product.metafields.product_details.subtitle
-%}
<product-grid-item class="affiliate-product-card product-card {% for tag in product.tags %}{% if tag contains 'TLsvegan' %} vegan_class {% elsif tag contains "StimulantFree" %} StimulantFree {% endif %} {% endfor %}bg-white flex flex-col p-4 rounded-xl text-blue-500 xgen-new-product stack-products_{{block_id}}_{{product.id}}">
  
  <div class="xgen-product-img" style="display:none;">
    {% assign split_title = product.title | split: '|' %}
    {% if product.variants.size == 1 or product.tags contains 'use-featured-image' %}
      <a class="block mx-auto w-64" href="{{ product.url | within: collection }}">
          {% assign product_featured_image = product.featured_image | split: '/' | last | split: '.' | first | replace: '/', ' ' | replace: '-', ' ' | replace: '_', ' ' %}
          <img src="{{ product.featured_image | img_url: 'master'}}" alt="{% if product.featured_image.alt %}{{ product.featured_image.alt }}{% else %}{{ product_featured_image }}{% endif %}" loading="lazy"/>
      </a>
    {% else %}
      <div class="swiper render-swiper">
        <div class="swiper-wrapper">
          {% for variant in product.variants %}
            {% if variant.option2 == '2 Tub' or variant.option2 == '3 Tub' %}
              {% continue %}
            {% endif %}
            <div class="swiper-slide" data-variant-id="{{ variant.id }}">
              <a class="block mx-auto w-64" href="{{ product.url | within: collection }}">
                {% assign product_featured_image1 = product.featured_image | split: '/' | last | split: '.' | first | replace: '/', ' ' | replace: '-', ' ' | replace: '_', ' ' %}
                <img src="{{product.featured_image | img_url: 'master'}}" alt="{% if product.featured_image.alt %}{{ product.featured_image.alt }}{% else %}{{ product_featured_image1 }}{% endif %}" loading="lazy"/>
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
  
  <div class="xgen-product-info">
    <div class="xgen-product-info-in">
      <div class="flex rctitle-flex">

    <h3 class="xgen-ptitle">
        {{ short_title }}
      </h3>
        <h2 class="font-semibold text-xl xgen-subptitle">
       {{ subtitle }}
      </h2>
       
      </div>
      
       <div class="flex items-center text-sm prating">
              <div class="flex space-x-1 text-orange-400">
                {%- assign review_average = product.metafields.yotpo.reviews_average | times: 1 -%}
                {%- for i in (1..5) -%}
                  {%- assign index_minus_one = i | minus: 1 -%}
                  {%- assign mod = review_average | modulo: index_minus_one -%}

                  {%- if review_average >= i -%}
                    <svg class="h-4 w-4" version="1.1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
                      <path d="m47.961 48h-47.945l39.914 31.543-15.941 48.441 40.059-29.871 39.938 29.871-15.871-48.863 39.918-31.121h-47.945l-16.094-47.996z" fill="currentColor"></path>
                    </svg>
                  {%- elsif mod >= 0.5 -%}
                    <svg class="h-4 w-4" version="1.1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
                      <path d="m128.02 48h-47.953l-16.094-48-16.031 48h-47.969l39.937 31.555-15.953 48.445 39.984-29.812 0.09375-0.0625 39.938 29.875-15.875-48.867zm-39.594 58.531-24.371-18.547-0.058594 0.0625v-56.953l10.164 24.906h29.812l-25.453 19.43z" fill="currentColor"></path>
                    </svg>
                  {%- else -%}
                    <svg class="h-4 w-4" version="1.1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
                      <path d="m64.008 31.113 10.172 24.887h29.809l-25.449 19.426 9.9023 31.105-24.387-18.543-24.387 18.109 9.8711-30.156-25.539-19.941h29.871l10.137-24.887m-16.043 16.887h-47.949l39.914 31.551-15.93 48.445 40.055-29.867 39.934 29.871-15.875-48.871 39.918-31.129h-47.945l-16.094-47.996z" fill="currentColor"></path>
                    </svg>
                  {%- endif %}
                {%- endfor -%}
              </div>

              <p class="ml-3 text-gray-500">
                <span class="font-bold text-black">{{ product.metafields.yotpo.reviews_average }}</span>/5.0
              </p>
            </div>
            
        {% comment %}            
            {% if product.metafields.custom.hide_best_seller_text == true %}  
              <div class="xgan-ptag">Bestseller</div>
            {% elsif product.metafields.custom.hide_best_seller_text == false %}
              
            {% else %}
              <div class="xgan-ptag">Bestseller</div>
            {% endif  %} 
        {% endcomment %}

          
          {% if product.metafields.custom.hide_best_seller_text == true %}
            {% if product.metafields.custom.best_seller_text_and_other_text != blank %}
                <div class="xgan-aptag" style="">
                {% assign text_strings =  product.metafields.custom.best_seller_text_and_other_text | split:',' %}
                {% for text in text_strings %}
                    {% if forloop.first %}
                      <span>Bestseller</span>  
                    {% else %}
                          <span>{{ text_strings }}</span>
                    {% endif %}
                  {% endfor %}
              </div>
            {% endif %}
          {% elsif product.metafields.custom.hide_best_seller_text == false %}
              {% if product.metafields.custom.best_seller_text_and_other_text != blank %}
                <div class="xgan-aptag" style="">
                {% assign text_strings =  product.metafields.custom.best_seller_text_and_other_text | split:',' %}
                {% for text in text_strings %}
                  {% if text == "Bestseller" %}
                  {% else %}
                    <span style="display:none;"></span>
                    <span>{{ text_strings }}</span>
                  {% endif %}
               {% endfor %}
              </div>
            {% endif %}
          {% else %}
              <div class="xgan-aptag" style="">
                  <span>Bestseller</span>
              </div>
          {% endif  %}
           <div class="font-semibold  text-blue-400 text-xl variant-price">
           {% if product.selected_or_first_available_selling_plan_allocation == blank %}
                <div id="singlereal_price_{{block_id}}_{{product.id}}">{{ product.price | money }}</div>
                <del id="singlecom_price_{{block_id}}_{{product.id}}">{{ product.compare_at_price | money }}</del>
            {% else %}
                <div class="real_price_{{block_id}}_{{product.id}}"></div>
                <del class="com_price_{{block_id}}_{{product.id}}"></del>
             {% endif %}
          </div> 
    </div>
    <div class="xgen-pdesc product_detail_{{ product.id }}">
      {% if product.metafields.custom.product_overview_detail != blank %}
        {{ product.metafields.custom.product_overview_detail }}
      {% endif %}
    </div> 
    
            <div class="package-list-wraper stack-text">
                  {% if product.variants.size > 0 %}
                  	{% if product.options[0] %}
                       <div class="package-list   ">
                  		<div class="input-wraper">
                          {% assign used = '' %}
                          <label for="select-one_{{product.id}}{{product.id}}">{{ product.options[0] }}</label>
                          <select id='select-one_{{product.id}}{{product.id}}' onchange="letsDoThis_{{product.id}}_{{product.id}}()">
                          {% for variant in product.variants %}
                          		{% unless used contains variant.option1 %}
                                  {% if product.selected_or_first_available_variant.id == variant.id  %}
                            		<option value="{{ variant.option1 }}" selected >{{ variant.option1 }}</option>
                                    {% else %}
                                    <option value="{{ variant.option1 }}">{{ variant.option1 }}</option>
                                    {% endif %}
                            		{% capture used %}{{ used }} {{ variant.option1 }}{% endcapture %}
                            	{% endunless %}
                          {% endfor %}
                          </select>
                         </div>
                       </div>
                    {% endif %}
                  	{% if product.options[1] %}
                       <div class="package-list" {% if product.options[1] == 'Quantity' %} style="display:none;" {% endif %}>
                         <div class="input-wraper">        
                          {% assign used = '' %}
                          <label for="select-one_{{product.id}}{{product.id}}">{{ product.options[1] }}</label>
                          <select id='select-two_{{product.id}}{{product.id}}' onchange="letsDoThis_{{product.id}}_{{product.id}}()">
                              {% for variant in product.variants %}
                                  {% unless used contains variant.option2 %}
                                    {% if product.selected_or_first_available_variant.id == variant.id  %}
                                      <option value="{{ variant.option2 }}" selected>{{ variant.option2 }}</option>
                                      {% else %}
                                      <option value="{{ variant.option2 }}">{{ variant.option2 }}</option>
                                      {% endif %}
                                      {% capture used %}{{ used }} {{ variant.option2 }}{% endcapture %}
                            	{% endunless %}
                              {% endfor %}
                          </select>
                      	</div>
                       </div>
                  {% endif %}
                  {% if product.options[2] %}
                     <div class="package-list" {% if product.options[2] == 'Quantity' %} style="display:none;" {% endif %}>
                        <div class="input-wraper">        
                            {% assign used = '' %}
                            <label for="select-one_{{product.id}}{{product.id}}">{{ product.options[2] }}</label>
                            <select id='select-three_{{product.id}}{{product.id}}' onchange="letsDoThis_{{product.id}}_{{product.id}}()">
                                {% for variant in product.variants %}
                                    {% unless used contains variant.option3 %}
                                      {% if product.selected_or_first_available_variant.id == variant.id  %}
                                        <option value="{{ variant.option3 }}" selected>{{ variant.option3 }}</option>
                                        {% else %}
                                        <option value="{{ variant.option3 }}">{{ variant.option3 }}</option>
                                        {% endif %}
                                        {% capture used %}{{ used }} {{ variant.option3 }}{% endcapture %}
                                    {% endunless %}
                                {% endfor %}
                            </select>
                        </div>
                     </div>
                  {% endif %}
              {% endif %}
              
			<input type="hidden" name="id" id="product-select_{{product.id}}_{{product.id}}" class="stack_vid3" value="{{ product.selected_or_first_available_variant.id }}" />	
  
            <input type="hidden" name="available" id="product-available_{{product.id}}_{{product.id}}" value="{% if product.available %}true{% else %}false{% endif %}" />	
  
            {% if product.selected_or_first_available_selling_plan_allocation == blank %}
            
            {% else %}
           
              <div class="p1_selling_plan_{{product.id}}_{{block_id}}_{{product.id}}" style="display:none;"></div>                
          
              <!-- 
                <div class="package-list deliveryf">
                  <p>Delivery Frequency</p>
                  <select class="selling_plan_{{block_id}}_{{ product.id }}"></select>
                </div> 
              -->

              <div class="deliveryf deliveryf_{{ block_id }}_{{ product.id }}" style="display:none;">
                <label><input type="radio" name="purchase_option_{{ product.id }}_{{block_id}}" class="onetimeoption" value="onetime" checked="checked"><div class="dtext"><span class="ltext">One time order</span><span class="stext">Give it a Try</span></div></label>
              </div>

              <div class="deliveryf dlast" style="display:none;">
                <label>
                  <input type="radio" name="purchase_option_{{ product.id }}_{{block_id}}" value="subsave" >
                  <span class="ltext">Deliver Every</span>
                  <select class="selling_plan_{{block_id}}_{{ product.id }}">
            
                  </select>
                  
                </label>
                <div class="xtags">
                  {% if product.metafields.custom.add_percentage_text != blank %}
                    <span>{{ product.metafields.custom.add_percentage_text }}</span>
                  {% else %}
                    <span>10% Off</span>
                  {% endif %}
                    {% if product.metafields.custom.hide_free_shipping_badge == true %} 
                      <span>Free Shipping</span>
                    {% elsif product.metafields.custom.hide_free_shipping_badge == false %}

                    {% else %}
                      <span>Free Shipping</span>
                    {% endif  %}
                  </div>
              </div>
            {% endif %}
       		
  
                {% assign frequency_text = product.metafields.custom.subscription_frequency_text | split: ',' %}
                {% assign f_text_zero = frequency_text[0] %}
                {% assign f_text_one = frequency_text[1] %}
                {% assign f_text_two = frequency_text[2] %}
                {% assign f_text_three = frequency_text[3] %}
              
        <script type="text/javascript">
          
        function letsDoThis_{{product.id}}_{{product.id}}() 
        {
        
          //console.log("clicked!");
          {% if product.options[0] %}
            var opt1 = document.getElementById("select-one_{{product.id}}{{product.id}}").value;
          {% endif %}
          {% if product.options[1] %}
             var opt2 = document.getElementById("select-two_{{product.id}}{{product.id}}").value;
          {% endif %}
          {% if product.options[2] %}
            var opt3 = document.getElementById("select-three_{{product.id}}{{product.id}}").value;
          {% endif %}
                                                           
          var id = "";
  
  
          {% for v in product.variants %}
            if(opt1=="{{ v.option1 }}" {% if product.options[1] %} && opt2 =="{{ v.option2 }}" {% endif %} {% if product.options[2] %} && opt3 == "{{ v.option3 }}" {% endif %}) 
            {
              var id = {{ v.id }};
              var price = "{{ v.price | money }}";
              var availablity = "{{ v.available }}";
            }
            
            {% unless v.inventory_quantity == 0 %}
            {% endunless %}
          {% endfor %}
             
          if(id != '') 
          {
            if(availablity === 'true')
            {
              document.getElementById("product-available_{{product.id}}_{{product.id}}").value = "true";
            }
            else
            {
              document.getElementById("product-available_{{product.id}}_{{product.id}}").value = "false";
            }

            {% if product.selected_or_first_available_selling_plan_allocation == blank %}
              document.getElementById("singlereal_price_{{block_id}}_{{product.id}}").innerHTML = price;
              document.getElementById("product-select_{{product.id}}_{{product.id}}").value = id;
            {% else %}
              document.getElementById("product-select_{{product.id}}_{{product.id}}").value = id;
            {% endif %}
          } 
          else 
          {
            {% if product.selected_or_first_available_selling_plan_allocation == blank %}
              document.getElementById("singlereal_price_{{block_id}}_{{product.id}}").innerHTML = "sold out";
              document.getElementById("product-select_{{product.id}}_{{product.id}}").value = "sold out";
              $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', true);
            {% else %}
              document.getElementById("product-select_{{product.id}}_{{product.id}}").value = "sold out";
            {% endif %}
          }
        }

        var variant_values = {{ product.variants | json }};
                // console.log(variant_values);
                var len = variant_values.length;
                // get recharge selling plan group
                var rechargeSellingPlanGroup = {{ product.selling_plan_groups | where: "app_id", "SKIO" | json }}

                for(var i = 0; i < len; i++)
                {
                  //console.log(variant_values[i].id);

                  // create array of selling plan allocations that are recharge's
                  var rechargeAllocations = variant_values[i].selling_plan_allocations.filter(allocation => allocation.selling_plan_group_id == rechargeSellingPlanGroup[0].id)

                  var len2 = rechargeAllocations.length;
                  var plans = rechargeAllocations;
                  for(var j=0; j < len2; j++)
                    {
                        if(j == 0)
                        {
                          $(".selling_plan_{{block_id}}_{{ product.id }}").append('<option value="selling_plan_'+j+'">{% if f_text_zero != blank %}{{ f_text_zero }}{% else %}15 days{% endif %}</option>'); 
                        }
                        if(j == 1)
                        {
                          $(".selling_plan_{{block_id}}_{{ product.id }}").append('<option selected value="selling_plan_'+j+'">{% if f_text_zero != blank %}{{ f_text_one }}{% else %}30 days{% endif %}</option>'); 
                        }
                        if(j == 2)
                        {
                          $(".selling_plan_{{block_id}}_{{ product.id }}").append('<option value="selling_plan_'+j+'">{% if f_text_zero != blank %}{{ f_text_two }}{% else %}45 days{% endif %}</option>'); 
                        }
                        if(j == 3)
                        {
                          $(".selling_plan_{{block_id}}_{{ product.id }}").append('<option value="selling_plan_'+j+'">{% if f_text_zero != blank %}{{ f_text_three }}{% else %}90 days{% endif %}</option>'); 
                        }
                       
                        $(".p1_selling_plan_{{product.id}}_{{block_id}}_{{product.id}}").append('<input class="onetime selling_plan_'+j+'" data-stack="{{block.id}}_{{product.id}}" data-price="'+plans[j].price+'" data-otp="'+plans[j].compare_at_price+'" name="selling_plan" value="'+plans[j].selling_plan_id+'">');
                        //console.log(plans[j].selling_plan_id);
                    }
                    if(i == 0)
                    {
                        break;
                    }
                          
                }
                </script>
          </div>

              <div class="price-btn-grid">
                <!--<h6 class="update_main_price_{{block_id}}_{{product.id}}">
        		{{ product.price | money }}
              </h6> -->
               <div class=" pricetext">
                 <div class="flex items-center quant-btn">
                <div class="">
                  <quantity-input>
                    <div class="flex items-center text-blue-500">
                      <button
                        class="bg-gray-300 flex h-10 items-center justify-center rounded-full text-blue-light w-10"
                        type="button"
                      >
                        {% render 'icon-minus' %}
                      </button>
                      

                      <input
                        class="border-2 border-gray-300 bg-transparent hide-selectors outline-none mx-2 rounded text-center w-16 focus:ring-0"
                        min="1"
                        name="quantity"
                        type="number"
                        value="1"
                        id="stack-products_qty_{{block_id}}_{{product.id}}"
                      />

                      <button
                        class="bg-gray-300 flex h-10 items-center justify-center rounded-full text-blue-light w-10"
                        type="button">
                        {% render 'icon-plus' %}
                      </button>
                    </div>
                  </quantity-input>
                </div>
                <div class="w-full" id="add-to-cart-button-container">
                      <button class="submit-stack-products_{{block_id}}_{{product.id}} button-alt" >Subscribe</button>
                </div>
             </div>
          </div>
      	</div>
    </div>
  <div style="display:none;">
                        
<script type="text/javascript">
  	
  
	$(document).ready(function()
	{

        
      
      	function format(num) {  return (num / 100).toFixed(2);}
  		var freq_val = $("input[name='purchaseoption_{{block_id}}_{{product.id}}']:checked").data("text");
		var freq_val2 = $("input[name='purchaseoption_{{block_id}}_{{product.id}}']:checked").val();
        var selling_plan_val = $(".selling_plan_{{block_id}}_{{ product.id }}").val();
      
        var choosen_option = $("input[name='purchase_option_{{product.id}}_{{block_id}}']:checked").val();
        if(choosen_option == 'subsave')
        {
          var avail = $("#product-available_{{product.id}}_{{product.id}}").val(); 
          if(avail == 'true')
          {
            $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Subscribe");
            $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', false);
          }
          else
          {
            $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Sold Out");
            $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', true);
          }
              		var total  = 0;
                  	var otptotal  = 0;
                	$(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
                	{
                      if(i < 1)
                      {
                            // recurring price                  
                    		var total = parseInt($(data).find('.'+selling_plan_val).attr('data-price'));
                            var parsed_total = format(total);
                            $(".real_price_{{block_id}}_{{product.id}}").text("$"+parsed_total);
                			// one time price                  
                            var otptotal = parseInt($(data).find('.'+selling_plan_val).attr('data-otp'));
                            var parsed_otptotal = format(otptotal);
                			$(".com_price_{{block_id}}_{{product.id}}").text("$"+parsed_otptotal);
                       }
            		});
            }
            else
            {
              var avail = $("#product-available_{{product.id}}_{{product.id}}").val(); 
              if(avail == 'true')
              {
                 $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Add to Cart");
                  $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', false);
              }
              else
              {
                $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Sold Out");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', true);
              }
               
                var total  = 0;
                var otptotal  = 0;

                $(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
                {	
                    if(i < 1)
                    {
                    	var otptotal = parseInt($(data).find('.'+selling_plan_val).attr('data-otp'));
                        var parsed_otptotal = format(otptotal);
                        $(".real_price_{{block_id}}_{{product.id}}").text("$"+parsed_otptotal);
          				$(".com_price_{{block_id}}_{{product.id}}").text("");
                    }
				});
            }
      
		
        $('input[type=radio][name=purchase_option_{{product.id}}_{{block_id}}]').change(function() 
        {
            var choosen_option = $("input[name='purchase_option_{{product.id}}_{{block_id}}']:checked").val();
            if(choosen_option == 'subsave')
            {
                 var avail = $("#product-available_{{product.id}}_{{product.id}}").val(); 
              if(avail == 'true')
              {
                 $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Subscribe");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', false);
              }
              else
              {
                $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Sold Out");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', true);
              }
                    
              		var total  = 0;
                  	var otptotal  = 0;
                	$(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
                	{
                      if(i < 1)
                      {
                            // recurring price                  
                    		var total = parseInt($(data).find('.'+selling_plan_val).attr('data-price'));
                            var parsed_total = format(total);
                            $(".real_price_{{block_id}}_{{product.id}}").text("$"+parsed_total);
                			// one time price                  
                            var otptotal = parseInt($(data).find('.'+selling_plan_val).attr('data-otp'));
                            var parsed_otptotal = format(otptotal);
                			$(".com_price_{{block_id}}_{{product.id}}").text("$"+parsed_otptotal);
                       }
            		});
            }
            else
            {
              var avail = $("#product-available_{{product.id}}_{{product.id}}").val(); 
              if(avail == 'true')
              {
                 $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Add to Cart");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', false);
              }
              else
              {
                $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Sold Out");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', true);
              }
                
                var total  = 0;
                var otptotal  = 0;

                $(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
                {	
                    if(i < 1)
                    {
                    	var otptotal = parseInt($(data).find('.'+selling_plan_val).attr('data-otp'));
                        var parsed_otptotal = format(otptotal);
                        $(".real_price_{{block_id}}_{{product.id}}").text("$"+parsed_otptotal);
          				$(".com_price_{{block_id}}_{{product.id}}").text("");
                    }
				});
            }
        });
      
      	$('#select-one_{{ product.id }}{{ product.id }}, #select-two_{{ product.id }}{{ product.id }}, #select-three_{{ product.id }}{{ product.id }}').change(function() 
        {
  			 var choosen_option = $("input[name='purchase_option_{{product.id}}_{{block_id}}']:checked").val();
            if(choosen_option == 'subsave')
            {
              var avail = $("#product-available_{{product.id}}_{{product.id}}").val(); 
              if(avail == 'true')
              {
                 $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Subscribe");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', false);
              }
              else
              {
                $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Sold Out");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', true);
              }
                
                    
              		var total  = 0;
                  	var otptotal  = 0;
                	$(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
                	{
                      if(i < 1)
                      {
                            // recurring price                  
                    		var total = parseInt($(data).find('.'+selling_plan_val).attr('data-price'));
                            var parsed_total = format(total);
                            $(".real_price_{{block_id}}_{{product.id}}").text("$"+parsed_total);
                			// one time price                  
                            var otptotal = parseInt($(data).find('.'+selling_plan_val).attr('data-otp'));
                            var parsed_otptotal = format(otptotal);
                			$(".com_price_{{block_id}}_{{product.id}}").text("$"+parsed_otptotal);
                       }
            		});
            }
            else
            {
               var avail = $("#product-available_{{product.id}}_{{product.id}}").val(); 
              if(avail == 'true')
              {
                 $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Add to Cart");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', false);
              }
              else
              {
                $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Sold Out");
                $(".submit-stack-products_{{block_id}}_{{product.id}}").attr('disabled', true);
              }
               
                var total  = 0;
                var otptotal  = 0;

                $(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
                {	
                    if(i < 1)
                    {
                    	var otptotal = parseInt($(data).find('.'+selling_plan_val).attr('data-otp'));
                        var parsed_otptotal = format(otptotal);
                        $(".real_price_{{block_id}}_{{product.id}}").text("$"+parsed_otptotal);
          				$(".com_price_{{block_id}}_{{product.id}}").text("");
                    }
				});
            }
    	});
    	$(".submit-stack-products_{{block_id}}_{{product.id}}").on("click", function (){
            var selling_plan_val= "";
            var items = [];
            var selling_plan_val = $(".selling_plan_{{block_id}}_{{ product.id }}").val();
            var choosen_option = $("input[name='purchase_option_{{product.id}}_{{block_id}}']:checked").val();
            if(choosen_option == 'onetime')
            {
                    $(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
                    {
                    	items.push({
                    		id: parseInt($(data).find('.stack_vid3').val()),
                    		quantity:$("#stack-products_qty_{{block_id}}_{{product.id}}").val()
                		});
                	});
            }
            else if(choosen_option == 'subsave')
            {
                 var selling_plan_val = $(".selling_plan_{{block_id}}_{{ product.id }}").val();
             	$(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
               	{
               		//var stack_id = new Date().getTime().toString();
      				var stack_id = $(data).find('.'+selling_plan_val).attr('data-stack');
                    var ssselling_plan = parseInt($(data).find('.'+selling_plan_val).val());
               		items.push({
               			id: parseInt($(data).find('.stack_vid3').val()),
                        quantity:$("#stack-products_qty_{{block_id}}_{{product.id}}").val(),
                        selling_plan: parseInt($(data).find('.'+selling_plan_val).val())
        			});
        		}); 
            }
            else
            {
                $(".stack-products_{{block_id}}_{{product.id}}").find(".stack-text").each(function (i,data)
                {
                    	items.push({
                    		id: parseInt($(data).find('.stack_vid3').val()),
                    		quantity:$("#stack-products_qty_{{block_id}}_{{product.id}}").val()
                		});
                });  
            }

          //     console.log("Items",items); 
                  Shopify.queue = [];
                  Shopify.queue = items;
                  var quantity = {{ cart.item_count }} ;
              	Shopify.moveAlong = function() {
                  // If we still have requests in the queue, let's process the next one.
                  if (Shopify.queue.length) 
                  {
                  	var request = Shopify.queue.shift();
                    //console.log("request",request); 
                      var data = 'id='+ request.variantId + '&quantity=1'
                      $.ajax({
                      	type: 'POST',
                          url: '/cart/add.js',
                          dataType: 'json',
                          data: request,
                          success: function(res)
                        	{
                                var butn_text = $(".submit-stack-products_{{block_id}}_{{product.id}}").text();
                                 console.log(butn_text);
                                if(butn_text == "Add to Cart")
                                {
                                    $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Adding");
                                }
                                else
                                {
                                    $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Subscribing...");
                                }
                                
                          	Shopify.moveAlong();
                              quantity += 1;
                          },
                          error: function()
                        	{
                          	// if it's not last one Move Along else update the cart number with the current quantity
                              if (Shopify.queue.length)
                              {
                              	Shopify.moveAlong()
                              } 
                            	else 
                              {
                                	
                              	//window.location="/cart";
                                $.getJSON('/cart.js', function(cart) 
                                {
                                  if(cart.item_count < 1 )
                                  {
                                      $('#cart-count').html("");
                                  }
                                  else
                                  {
                                      $('#cart-count').html("<number class='number'>"+cart.item_count+"</number>");
                                  }
                                                     
                                });
                                  openCartMenu();
                              }
                        	}
              		});
              	}
              	// If the queue is empty, we add 1 to cart
                  else 
                  {
                  	quantity += 1;
                    	
                       $.getJSON('/cart.js', function(cart) 
                      {
                        if(cart.item_count < 1 )
                        {
                            $('#cart-count').html("");
                        }
                        else
                        {
                            $('#cart-count').html("<number class='number'>"+cart.item_count+"</number>");
                        }
                                           
                      });
                      //window.location="/cart";
                      openCartMenu();
                     var butn_text = $(".submit-stack-products_{{block_id}}_{{product.id}}").text();
                        
                        if(butn_text == "Adding")
                        {
                            console.log(butn_text);
                            $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Add to Cart");
                        }
                        else
                        {
                            console.log(butn_text);
                            $(".submit-stack-products_{{block_id}}_{{product.id}}").text("Subscribe");  
                        }
              	}
              };
              Shopify.moveAlong();
          
});
});
  
   
</script>
</div>
</product-grid-item>


  
